[concurrency](#concurrency)


## concurrency


[//]: # (독립적인 작업들 간에 시간을 분할하여 실행함으로써 동시에 실행되는 것처럼 보이도록 처리하는 능력을 말한다)

동시성은 여러 프로세스/스레드에서 공유 자원을 통해 작업을 처리하는 것을 말한다 

어떤 프로세스/스레드의 특정 작업을 처리하기 위해 나머지 작업들이 기다려야 한다면 **해당 작업이 수행되지 않거나 점유하고 있는 자원(critical section)이 사용되지 않는 유휴 상태(idle status)**에 빠지게 된다

또한 **여러 프로세스/스레드에서 공유 자원에 접근하여 데이터의 일관성과 무결성이 깨지거나 작업의 수행 순서에 따라 결과가 달라지는 동시성 문제**가 발생한다

이러한 문제를 해결하기 위해 **각 작업에 대한 처리 시간을 분할**하여 유휴 상태에 빠지지 않게 하거나 자원에 특정 프로세스/스레드만 접근할 수 있도록 하는 **동기화**, **스레드 세이프 자료구조**, **원자적 연산**, **비동기 프로그래밍** 등의 해결책을 구현한다

동기화란 동시성을 제어하는 메커니즘을 말한다

## 동시성 문제

동시성 문제 원인
- 공유 자원(임계 구역)에 대한 동시 접근 
- 작업 간 수행 순서 불확실성


### 경쟁 상태 (race condition)

여러 프로세스/스레드가 공유 자원(같은 변수/객체 등)에 접근하고 수정하려고 할 때 발생하는 문제로 상태 불일치 문제를 초래한다 

#### 상태 불일치

공유 데이터의 상태가 일관성을 잃는 문제

동기화 처리를 통해 상태 불일치 문제를 해결할 수 있다

[경쟁 상태 코드(자바)](./src/java/src/test/java/concurrency/RaceConditionTest.java)


### 교착 상태 (deadlock)

둘 이상의 스레드가 서로에게 필요한 자원을 점유한 채로 무한 대기에 빠지는 문제

A 스레드가 자원 1을 소유하고 자원 2를 기다리는 중

B 스레드가 자원 2를 소유하고 자원 1을 기다리는 중

-> 두 스레드는 자원을 획득하기 위해 영원히 대기하는 상태에 빠진다


### 기아 상태 (starvation)

한 스레드가 자원을 지속적으로 점유하지 못해 작업이 무한히 지연되는 문제

우선순위가 낮은 스레드가 높은 우선순위의 스레드에게 계속 밀릴 때 발생되는 문제


### 활성화 지연 (livelock)

스레드가 서로를 기다리거나 자원을 양보하다가 무한히 작업을 진행하지 못하는 문제


## 임계 구역

임계 구역(critical section)이란 공유 자원에 접근하는 코드 블록으로 동시에 여러 스레드가 진입하면 데이터 경합이 발생하거나 데이터 무결성이 깨질 수 있는 부분을 의미한다

이를 해결하기 위해 동기화 메커니즘(임계 구역 보호)이나 동시성 알고리즘, 스레드 세이프 자료구조 등을 사용해서 동시성 문제를 해결한다

임계 구역 문제를 해결하려면 다음 조건(동기화 조건 또는 동시성 제어 조건)을 충족시켜야 한다

### 동시성 제어 조건

#### 1. 상호 배제 (mutual exclusion)

한 번에 하나의 스레드만 임계 구역에 진입할 수 있어야 한다

락 또는 뮤텍스를 사용하여 다른 스레드가 대기하도록 보장해야 한다

#### 2. 진행 (progress)

임계 구역에 진입하려는 스레드가 없으면(공유 자원을 사용하고 있는 스레드가 없으면) 대기 중인 스레드 중 하나가 반드시 임계 구역에서 작업을 진행할 수 있어야 한다

특정 스레드가 무한히 대기 상태에 빠지지 않도록 보장해야 한다

#### 3. 한정된 대기 (bounded waiting)

스레드가 임계 구역에 진입하기 위해 대기하는 시간이 유한해야 한다

특정 스레드가 [기아 상태](#기아-상태-starvation)에 빠지지 않도록 보장해야 한다

#### 4. 비선점 (non-preemption)

임계 구역에 진입한 스레드는 작업을 완료하고 자원을 해제하기 전까지 강제로 중단되지 않아야 한다

외부의 간섭없이 공유 자원을 점유한 스레드가 작업을 끝낼 수 있어야 한다


## 임계 구역 문제 해결, 동기화 메커니즘 및 도구

임계 구역을 보호하기 위한 동기화 처리를 적용하거나 동시성 문제를 우회할 수 있는 도구 

동기화 처리
- 경쟁 상태를 방지하기 위해 한 번에 하나의 스레드만 접근하도록 동기화 도구를 사용해 공유 자원을 보호한다
- 락

동시성 문제 우회
- 스레드 세이프 자료구조
- 원자적 연산
- 비동기 프로그래밍

### 락

소유권이 있어야 공유 자원에 접근할 수 있는 메커니즘

락을 획득한 스레드에서 공유 자원에 접근하고 나머지 스레드는 락을 획득하기 위해 대기한다

두 개 이상의 스레드가 대기를 해야 된다면 스레드 간 대기 순번을 정해야 하고, 락을 획득한 스레드는 컨텍스트 스위칭이 발생한다


### 뮤텍스와 세마포어


뮤텍스와 세마포어는 운영체제에서 제공하는 기본 동기화 메커니즘으로 [상호 배제](#1-상호-배제-mutual-exclusion) 조건을 달성하기 위한 기법으로 락을 기반으로 임계 구역에 대한 동기화 처리한다

뮤텍스 mutex (mutual exclusion)
- 뮤텍스는 자원의 상호 배제를 보장하는 락의 한 가지 형태로 소유권 개념이 존재한다
- 뮤텍스를 요청하여 락을 획득한 하나의 스레드만이 공유 자원에 접근하거나 락을 해제할 수 있다
- 해제된 락은 대기 중인 다음 스레드가 소유권을 획득한다
- 파일 쓰기, 메모리 수정 등에서 사용

세마포어 (semaphore)
- 세마포어는 공유 자원에 동시에 접근할 수 있는 스레드 허용 개수(permit)를 제한하여 동시 접근이 가능한 동기화 방법이다
- 자원에 접근하려는 스레드는 permit을 요청(acquire)하고, 자원 사용이 끝나면 permit을 반환한다(release)
- 모든 permit을 사용 중이면 다른 스레드들은 대기한다
- 뮤텍스에 비해 소유권 개념이 약해서 반환하는 스레드가 반드시 permit을 획득한 스레드일 필요가 없다
- DB 커넥션 풀, 네트워크 요청 처리 등에서 사용


### 조건 변수


### 모니터

비공정 정책


### 스핀 락

### 이벤트


### CAS (Compare-And-Swap)


## 백엔드의 동시성 처리